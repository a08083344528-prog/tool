<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–¶æ¥­é€²æ—ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: nowrap;
            overflow-x: auto;
        }
        
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            white-space: nowrap;
            text-align: center;
        }
        
        .tab.active {
            background: white;
            color: #4facfe;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #4facfe;
        }
        
        .tab-content {
            padding: 30px;
            min-height: 500px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .btn {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }
        
        .search-box {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-box input {
            padding-left: 45px;
        }
        
        .search-box::before {
            content: "ğŸ”";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }
        
        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .records-table th {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .records-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .records-table tr:hover {
            background: #f8f9fa;
        }
        
        .rank-a { color: #dc3545; font-weight: bold; }
        .rank-b { color: #fd7e14; font-weight: bold; }
        .rank-c { color: #28a745; font-weight: bold; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #4facfe;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1.1em;
            color: #666;
            font-weight: 600;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tab-content {
                padding: 20px 15px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-group input, .form-group select, .form-group textarea {
                font-size: 16px; /* prevent zoom on iOS */
                padding: 15px;
            }
            
            .tabs {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                font-size: 12px;
                padding: 12px 8px;
                min-width: 100px;
                -webkit-tap-highlight-color: transparent;
            }
            
            .records-table {
                font-size: 12px;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .records-table thead,
            .records-table tbody,
            .records-table th,
            .records-table td,
            .records-table tr {
                display: block;
            }
            
            .records-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .records-table tr {
                background: white;
                border: 1px solid #e9ecef;
                border-radius: 10px;
                margin-bottom: 10px;
                padding: 15px;
                position: relative;
            }
            
            .records-table td {
                border: none;
                position: relative;
                padding: 8px 0;
                text-align: left;
                white-space: normal;
            }
            
            .records-table td:before {
                content: attr(data-label) ": ";
                font-weight: bold;
                color: #666;
                display: inline-block;
                width: 100px;
            }
            
            .btn {
                padding: 15px 25px;
                font-size: 16px;
                margin: 5px;
                -webkit-tap-highlight-color: transparent;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .stat-card {
                padding: 20px 15px;
            }
            
            .stat-number {
                font-size: 2em;
            }
            
            .search-box input {
                font-size: 16px;
                padding: 15px 15px 15px 45px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ˆ å–¶æ¥­é€²æ—ç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>
            <p>åŠ¹ç‡çš„ãªå–¶æ¥­æ´»å‹•ã‚’ã‚µãƒãƒ¼ãƒˆ</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('input')">ğŸ“ æ–°è¦ç™»éŒ²</button>
            <button class="tab" onclick="showTab('list')">ğŸ“‹ ä¸€è¦§ãƒ»æ¤œç´¢</button>
            <button class="tab" onclick="showTab('stats')">ğŸ“Š çµ±è¨ˆ</button>
        </div>
        
        <div id="input-tab" class="tab-content">
            <h2 id="form-title">ğŸ“ æ–°è¦è¨ªå•è¨˜éŒ²</h2>
            <div id="success-message" class="success-message hidden">
                âœ… è¨˜éŒ²ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼
            </div>
            
            <form id="visitForm">
                <input type="hidden" id="editId" value="">
                <div class="form-row">
                    <div class="form-group">
                        <label for="company">è¨ªå•å…ˆï¼ˆä¼šç¤¾åï¼‰*</label>
                        <input type="text" id="company" required>
                    </div>
                    <div class="form-group">
                        <label for="contact">æ‹…å½“è€…å</label>
                        <input type="text" id="contact">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="address">ä½æ‰€</label>
                    <input type="text" id="address">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">é›»è©±ç•ªå·</label>
                        <input type="tel" id="phone">
                    </div>
                    <div class="form-group">
                        <label for="rank">ãƒ©ãƒ³ã‚¯*</label>
                        <select id="rank" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="A">Aï¼ˆæœ€é‡è¦ï¼‰</option>
                            <option value="B">Bï¼ˆé‡è¦ï¼‰</option>
                            <option value="C">Cï¼ˆé€šå¸¸ï¼‰</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">è¨ªå•æ—¥*</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="status">è¨ªå•çµæœ</label>
                        <select id="status">
                            <option value="è¨ªå•æ¸ˆã¿">è¨ªå•æ¸ˆã¿</option>
                            <option value="ä¸åœ¨">ä¸åœ¨</option>
                            <option value="ã‚¢ãƒå–å¾—">ã‚¢ãƒå–å¾—</option>
                            <option value="å•†è«‡">å•†è«‡</option>
                            <option value="å—æ³¨">å—æ³¨</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="nextVisit">æ¬¡å›è¨ªå•äºˆå®šæ—¥</label>
                        <input type="date" id="nextVisit">
                    </div>
                    <div class="form-group">
                        <label for="followUp">ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—å¿…è¦åº¦</label>
                        <select id="followUp">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="ç·Šæ€¥">ç·Šæ€¥ï¼ˆ1é€±é–“ä»¥å†…ï¼‰</option>
                            <option value="é«˜">é«˜ï¼ˆ2é€±é–“ä»¥å†…ï¼‰</option>
                            <option value="ä¸­">ä¸­ï¼ˆ1ãƒ¶æœˆä»¥å†…ï¼‰</option>
                            <option value="ä½">ä½ï¼ˆé©å®œï¼‰</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“ é¡§å®¢ã‹ã‚‰ã®åå¿œ</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="inquiries">å•ã„åˆã‚ã›æ•°ï¼ˆä»¶ï¼‰</label>
                            <input type="number" id="inquiries" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="users">åˆ©ç”¨è€…æ•°ï¼ˆäººï¼‰</label>
                            <input type="number" id="users" min="0" placeholder="0">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="content">è¨ªå•å†…å®¹ãƒ»ãƒ¡ãƒ¢</label>
                    <textarea id="content" rows="4" placeholder="è¨ªå•ã®è©³ç´°ã€æ¬¡å›ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç­‰ã‚’è¨˜å…¥"></textarea>
                </div>
                
                <button type="submit" class="btn" id="submit-btn">ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜</button>
                <button type="button" class="btn btn-secondary" onclick="clearForm()">ğŸ”„ ã‚¯ãƒªã‚¢</button>
                <button type="button" class="btn btn-secondary hidden" id="cancel-edit-btn" onclick="cancelEdit()">âŒ ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </form>
        </div>
        
        <div id="list-tab" class="tab-content hidden">
            <h2>ğŸ“‹ è¨ªå•è¨˜éŒ²ä¸€è¦§</h2>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ä¼šç¤¾åã€æ‹…å½“è€…åã€ä½æ‰€ã§æ¤œç´¢...">
            </div>
            
            <div style="margin-bottom: 20px;">
                <select id="rankFilter">
                    <option value="">å…¨ã¦ã®ãƒ©ãƒ³ã‚¯</option>
                    <option value="A">Aãƒ©ãƒ³ã‚¯ã®ã¿</option>
                    <option value="B">Bãƒ©ãƒ³ã‚¯ã®ã¿</option>
                    <option value="C">Cãƒ©ãƒ³ã‚¯ã®ã¿</option>
                </select>
                
                <select id="statusFilter" style="margin-left: 10px;">
                    <option value="">å…¨ã¦ã®çµæœ</option>
                    <option value="è¨ªå•æ¸ˆã¿">è¨ªå•æ¸ˆã¿</option>
                    <option value="ä¸åœ¨">ä¸åœ¨</option>
                    <option value="ã‚¢ãƒå–å¾—">ã‚¢ãƒå–å¾—</option>
                    <option value="å•†è«‡">å•†è«‡</option>
                    <option value="å—æ³¨">å—æ³¨</option>
                </select>
                
                <button class="btn" onclick="exportData()" style="margin-left: 10px;">ğŸ“¥ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button class="btn" onclick="importData()" style="margin-left: 10px;">ğŸ“¤ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileImport(this)">
                <button class="btn btn-secondary" onclick="clearAllData()" style="margin-left: 10px; background: #dc3545;">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
            </div>
            
            <div id="recordsList">
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>æ—¥ä»˜</th>
                            <th>ä¼šç¤¾å</th>
                            <th>æ‹…å½“è€…</th>
                            <th>ãƒ©ãƒ³ã‚¯</th>
                            <th>çµæœ</th>
                            <th>æ¬¡å›äºˆå®š</th>
                            <th>å•åˆã›</th>
                            <th>åˆ©ç”¨è€…</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <!-- Records will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="stats-tab" class="tab-content hidden">
            <h2>ğŸ“Š çµ±è¨ˆæƒ…å ±</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalVisits">0</div>
                    <div class="stat-label">ç·è¨ªå•æ•°</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="totalCompanies">0</div>
                    <div class="stat-label">è¨ªå•å…ˆä¼æ¥­æ•°</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="rankACount">0</div>
                    <div class="stat-label">Aãƒ©ãƒ³ã‚¯ä¼æ¥­</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="successRate">0%</div>
                    <div class="stat-label">å—æ³¨ç‡</div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>ğŸ“… æœˆåˆ¥è¨ªå•æ•°</h3>
                <div id="monthlyStats"></div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>ğŸ“… æœˆåˆ¥è¨ªå•æ•°</h3>
                <div id="monthlyStats"></div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>ğŸ† ãƒ©ãƒ³ã‚¯åˆ¥åˆ†æ</h3>
                <div id="rankStats"></div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>ğŸ“… æ¬¡å›è¨ªå•äºˆå®š</h3>
                <div id="upcomingVisits"></div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>ğŸ“ é¡§å®¢åå¿œã‚µãƒãƒªãƒ¼</h3>
                <div id="responseStats"></div>
            </div>
        </div>
    </div>

    <script>
// --- è¨­å®š ---
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKetPcG4IaeJanpPFpoYvQfCrv3dIxZLaTc37oASJ_XpvP5Pbii5qGGvOYIuDwdUO5/exec';
// -----------

let visits = []; // ãƒ‡ãƒ¼ã‚¿ã¯å¸¸ã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('date').valueAsDate = new Date();
    setupEventListeners();
    loadData(); // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã‚€
});

function setupEventListeners() {
    document.getElementById('visitForm').addEventListener('submit', saveVisit);
    document.getElementById('searchInput').addEventListener('input', displayRecords);
    document.getElementById('rankFilter').addEventListener('change', displayRecords);
    document.getElementById('statusFilter').addEventListener('change', displayRecords);
    document.querySelectorAll('.tab').forEach(tabButton => {
        tabButton.addEventListener('click', () => {
            const tabName = tabButton.dataset.tab;
            showTab(tabName);
        });
    });
}

function showLoading(show) {
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼ˆç°¡æ˜“ç‰ˆã€å¿…è¦ã«å¿œã˜ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´ï¼‰
    const loader = document.getElementById('loader') || document.createElement('div');
    loader.id = 'loader';
    if(show) {
        loader.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 2em;';
        loader.textContent = 'ğŸ”„ èª­ã¿è¾¼ã¿ä¸­...';
        document.body.appendChild(loader);
    } else {
        if (loader.parentNode) {
            loader.parentNode.removeChild(loader);
        }
    }
}

// ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã¿
async function loadData() {
    showLoading(true);
    try {
        const response = await fetch(SCRIPT_URL);
        if (!response.ok) throw new Error('Network response was not ok');
        visits = await response.json();
        // æ•°å€¤å‹ã«å¤‰æ›
        visits.forEach(v => {
            v.id = parseInt(v.id);
            v.inquiries = parseInt(v.inquiries) || 0;
            v.users = parseInt(v.users) || 0;
        });
        displayRecords();
        updateStats();
    } catch (error) {
        console.error('Error loading data:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    } finally {
        showLoading(false);
    }
}

// è¨ªå•è¨˜éŒ²ã‚’ä¿å­˜ãƒ»æ›´æ–°
async function saveVisit(e) {
    e.preventDefault();
    showLoading(true);
    
    const editId = document.getElementById('editId').value;
    const isEditing = !!editId;

    const visit = {
        id: isEditing ? parseInt(editId) : Date.now(),
        company: document.getElementById('company').value,
        contact: document.getElementById('contact').value,
        address: document.getElementById('address').value,
        phone: document.getElementById('phone').value,
        rank: document.getElementById('rank').value,
        date: document.getElementById('date').value,
        status: document.getElementById('status').value,
        nextVisit: document.getElementById('nextVisit').value,
        followUp: document.getElementById('followUp').value,
        inquiries: parseInt(document.getElementById('inquiries').value) || 0,
        users: parseInt(document.getElementById('users').value) || 0,
        content: document.getElementById('content').value,
        lastModified: new Date().toISOString()
    };

    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'save', record: visit }),
            headers: { 'Content-Type': 'application/json' },
        });

        const result = await response.json();
        if (result.status === 'success') {
            await loadData(); // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
            showSuccessMessage(isEditing ? 'æ›´æ–°' : 'ä¿å­˜');
            clearForm();
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error saving data:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// è¨˜éŒ²ã‚’å‰Šé™¤
async function deleteVisit(id) {
    if (confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        showLoading(true);
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'delete', record: { id: id } }),
                headers: { 'Content-Type': 'application/json' },
            });
            const result = await response.json();
            if (result.status === 'success') {
                await loadData(); // å†èª­ã¿è¾¼ã¿
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error deleting data:', error);
            alert('ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        } finally {
            showLoading(false);
        }
    }
}

// å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
async function clearAllData() {
    if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        if (confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆä¸Šã®ãƒ‡ãƒ¼ã‚¿ãŒå…¨ã¦æ¶ˆãˆã¾ã™ã€‚')) {
            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'clearAll' }),
                    headers: { 'Content-Type': 'application/json' },
                });
                const result = await response.json();
                if (result.status === 'success') {
                    await loadData();
                    alert('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error clearing data:', error);
                alert('å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
    }
}

function showSuccessMessage(actionType) {
    const message = document.getElementById('success-message');
    message.innerHTML = `âœ… è¨˜éŒ²ãŒæ­£å¸¸ã«${actionType}ã•ã‚Œã¾ã—ãŸï¼`;
    message.classList.remove('hidden');
    setTimeout(() => {
        message.classList.add('hidden');
    }, 3000);
}

// CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ç›´æ¥DLã™ã‚‹ã»ã†ãŒä¾¿åˆ©ãªã®ã§ç°¡æ˜“åŒ–ï¼‰
function exportData() {
    alert('Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ç›´æ¥CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
}

// CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆåŒæ§˜ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ç›´æ¥è²¼ã‚Šä»˜ã‘ã‚’æ¨å¥¨ï¼‰
function importData() {
    alert('Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ç›´æ¥ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
}

// ã“ã‚Œä»¥é™ã®é–¢æ•°ï¼ˆclearForm, editVisit, displayRecordsãªã©ï¼‰ã¯ã€
// ãƒ­ãƒ¼ã‚«ãƒ«ç‰ˆï¼ˆå‰å›ã®å›ç­”ï¼‰ã¨ã»ã¼åŒã˜ãªã®ã§ã€çœç•¥ã›ãšã«ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
// ãŸã ã—ã€saveData, loadData ã®ã‚ˆã†ã«ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ã«ç½®ãæ›ã‚ã£ãŸé–¢æ•°ã¯ä¸è¦ã§ã™ã€‚
// ä»¥ä¸‹ã«å†æ²ã—ã¾ã™ã€‚

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
    if (tabName === 'stats') updateStats();
    if (tabName === 'list') displayRecords();
}

function clearForm() {
    document.getElementById('visitForm').reset();
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('editId').value = '';
    document.getElementById('form-title').textContent = 'ğŸ“ æ–°è¦è¨ªå•è¨˜éŒ²';
    document.getElementById('submit-btn').textContent = 'ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜';
    document.getElementById('cancel-edit-btn').classList.add('hidden');
}

function editVisit(id) {
    const visit = visits.find(v => v.id === id);
    if (!visit) return;
    
    document.getElementById('editId').value = visit.id;
    document.getElementById('company').value = visit.company;
    document.getElementById('contact').value = visit.contact || '';
    document.getElementById('address').value = visit.address || '';
    document.getElementById('phone').value = visit.phone || '';
    document.getElementById('rank').value = visit.rank;
    document.getElementById('date').value = visit.date;
    document.getElementById('status').value = visit.status;
    document.getElementById('content').value = visit.content || '';
    document.getElementById('nextVisit').value = visit.nextVisit || '';
    document.getElementById('followUp').value = visit.followUp || '';
    document.getElementById('inquiries').value = visit.inquiries || 0;
    document.getElementById('users').value = visit.users || 0;
    
    document.getElementById('form-title').textContent = 'âœï¸ è¨ªå•è¨˜éŒ²ã®ç·¨é›†';
    document.getElementById('submit-btn').textContent = 'ğŸ’¾ å¤‰æ›´ã‚’ä¿å­˜';
    document.getElementById('cancel-edit-btn').classList.remove('hidden');
    
    showTab('input');
}

function cancelEdit() {
    clearForm();
}

function displayRecords() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rankFilter = document.getElementById('rankFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    let filteredVisits = visits.filter(visit => {
        const company = visit.company || '';
        const contact = visit.contact || '';
        const address = visit.address || '';
        const matchesSearch = company.toLowerCase().includes(searchTerm) ||
                            contact.toLowerCase().includes(searchTerm) ||
                            address.toLowerCase().includes(searchTerm);
        
        const matchesRank = !rankFilter || visit.rank === rankFilter;
        const matchesStatus = !statusFilter || visit.status === statusFilter;
        
        return matchesSearch && matchesRank && matchesStatus;
    });
    
    filteredVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const tbody = document.getElementById('recordsBody');
    tbody.innerHTML = '';
    
    filteredVisits.forEach(visit => {
        const row = document.createElement('tr');
        const nextVisitWarning = getNextVisitWarning(visit.nextVisit);
        const nextVisitDisplay = visit.nextVisit ? 
            `<span style="${nextVisitWarning.style}">${formatDate(visit.nextVisit)} ${nextVisitWarning.icon}</span>` : 
            '-';
        
        row.innerHTML = `
            <td data-label="æ—¥ä»˜">${formatDate(visit.date)}</td>
            <td data-label="ä¼šç¤¾å"><strong>${visit.company}</strong></td>
            <td data-label="æ‹…å½“è€…">${visit.contact || '-'}</td>
            <td data-label="ãƒ©ãƒ³ã‚¯"><span class="rank-${visit.rank.toLowerCase()}">${visit.rank}</span></td>
            <td data-label="çµæœ">${visit.status}</td>
            <td data-label="æ¬¡å›äºˆå®š">${nextVisitDisplay}</td>
            <td data-label="å•åˆã›">${visit.inquiries || 0}ä»¶</td>
            <td data-label="åˆ©ç”¨è€…">${visit.users || 0}äºº</td>
            <td data-label="æ“ä½œ">
                <button onclick="editVisit(${visit.id})" style="background:#28a745; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; margin-right:5px;">ç·¨é›†</button>
                <button onclick="deleteVisit(${visit.id})" style="background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">å‰Šé™¤</button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    if (filteredVisits.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px; color:#666;">è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
    }
}

// ã“ã‚Œä»¥é™ã®çµ±è¨ˆé–¢é€£ã®é–¢æ•°ã¯å¤‰æ›´ãªã—ã§OK
function getNextVisitWarning(nextVisitDate) {
    if (!nextVisitDate) return { style: '', icon: '' };
    const today = new Date();
    const nextDate = new Date(nextVisitDate);
    const diffTime = nextDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    if (diffDays < 0) return { style: 'color: #dc3545; font-weight: bold;', icon: 'âš ï¸' };
    if (diffDays <= 3) return { style: 'color: #fd7e14; font-weight: bold;', icon: 'ğŸ””' };
    if (diffDays <= 7) return { style: 'color: #ffc107; font-weight: bold;', icon: 'ğŸ“…' };
    return { style: '', icon: '' };
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '-';
    return `${date.getMonth() + 1}/${date.getDate()}`;
}

function updateStats() {
    const totalVisits = visits.length;
    const uniqueCompanies = new Set(visits.map(v => v.company)).size;
    const rankACount = visits.filter(v => v.rank === 'A').length;
    const successCount = visits.filter(v => v.status === 'å—æ³¨').length;
    const successRate = totalVisits > 0 ? Math.round((successCount / totalVisits) * 100) : 0;
    
    document.getElementById('totalVisits').textContent = totalVisits;
    document.getElementById('totalCompanies').textContent = uniqueCompanies;
    document.getElementById('rankACount').textContent = rankACount;
    document.getElementById('successRate').textContent = successRate + '%';
    
    updateMonthlyStats();
    updateRankStats();
    updateUpcomingVisits();
    updateResponseStats();
}

function updateMonthlyStats() {
    const monthlyData = {};
    visits.forEach(visit => {
        if(!visit.date) return;
        const month = visit.date.substring(0, 7); // YYYY-MM
        monthlyData[month] = (monthlyData[month] || 0) + 1;
    });
    const monthlyStatsEl = document.getElementById('monthlyStats');
    monthlyStatsEl.innerHTML = '';
    Object.entries(monthlyData).sort((a, b) => b[0].localeCompare(a[0])).forEach(([month, count]) => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; justify-content: space-between; padding: 10px; background: white; margin: 5px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
        div.innerHTML = `<span>${month}</span><strong>${count}ä»¶</strong>`;
        monthlyStatsEl.appendChild(div);
    });
    if (Object.keys(monthlyData).length === 0) {
        monthlyStatsEl.innerHTML = '<p style="text-align:center; color:#666;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
    }
}

function updateRankStats() {
    const rankData = { 'A': 0, 'B': 0, 'C': 0 };
    visits.forEach(v => {
        if (v.rank && rankData.hasOwnProperty(v.rank)) {
            rankData[v.rank]++;
        }
    });
    const rankStatsEl = document.getElementById('rankStats');
    rankStatsEl.innerHTML = '';
    Object.entries(rankData).forEach(([rank, count]) => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; justify-content: space-between; padding: 10px; background: white; margin: 5px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
        div.innerHTML = `<span class="rank-${rank.toLowerCase()}">${rank}ãƒ©ãƒ³ã‚¯</span><strong>${count}ä»¶</strong>`;
        rankStatsEl.appendChild(div);
    });
}

function updateUpcomingVisits() {
    const today = new Date();
    today.setHours(0,0,0,0);
    const upcomingVisits = visits
        .filter(v => v.nextVisit)
        .map(v => ({...v, daysUntil: Math.ceil((new Date(v.nextVisit) - today) / (1000 * 60 * 60 * 24)) }))
        .filter(v => v.daysUntil >= 0) // æœªæ¥ã®äºˆå®šã®ã¿
        .sort((a, b) => a.daysUntil - b.daysUntil)
        .slice(0, 10);
    
    const upcomingEl = document.getElementById('upcomingVisits');
    upcomingEl.innerHTML = '';
    
    if (upcomingVisits.length === 0) {
        upcomingEl.innerHTML = '<p style="text-align:center; color:#666;">äºˆå®šã•ã‚ŒãŸè¨ªå•ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
    }
    
    upcomingVisits.forEach(visit => {
        const div = document.createElement('div');
        const warning = getNextVisitWarning(visit.nextVisit);
        const urgencyText = visit.daysUntil === 0 ? 'ä»Šæ—¥' : `${visit.daysUntil}æ—¥å¾Œ`;
        div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; margin: 5px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
        div.innerHTML = `<div><strong>${visit.company}</strong><span style="margin-left: 10px; color: #666;">${visit.followUp ? `(${visit.followUp})` : ''}</span></div><span style="${warning.style}">${urgencyText} ${warning.icon}</span>`;
        upcomingEl.appendChild(div);
    });
}

function updateResponseStats() {
    const totalInquiries = visits.reduce((sum, v) => sum + (v.inquiries || 0), 0);
    const totalUsers = visits.reduce((sum, v) => sum + (v.users || 0), 0);
    const avgInquiries = visits.length > 0 ? (totalInquiries / visits.length).toFixed(1) : 0;
    const avgUsers = visits.length > 0 ? (totalUsers / visits.length).toFixed(1) : 0;

    const responseEl = document.getElementById('responseStats');
    responseEl.innerHTML = '';
    const stats = [
        { label: 'ç·å•ã„åˆã‚ã›æ•°', value: `${totalInquiries}ä»¶`, color: '#4facfe' },
        { label: 'ç·åˆ©ç”¨è€…æ•°', value: `${totalUsers}äºº`, color: '#00f2fe' },
        { label: 'å¹³å‡å•ã„åˆã‚ã›/è¨ªå•', value: `${avgInquiries}ä»¶`, color: '#667eea' },
        { label: 'å¹³å‡åˆ©ç”¨è€…/è¨ªå•', value: `${avgUsers}äºº`, color: '#764ba2' }
    ];
    stats.forEach(stat => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; justify-content: space-between; padding: 10px; background: white; margin: 5px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
        div.innerHTML = `<span>${stat.label}</span><strong style="color: ${stat.color};">${stat.value}</strong>`;
        responseEl.appendChild(div);
    });
}
    </script>
</body>
</html>
