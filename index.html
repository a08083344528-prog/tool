<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âñ∂Ê•≠ÈÄ≤ÊçóÁÆ°ÁêÜ„ÉÑ„Éº„É´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: nowrap;
            overflow-x: auto;
        }
        
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            white-space: nowrap;
            text-align: center;
        }
        
        .tab.active {
            background: white;
            color: #4facfe;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #4facfe;
        }
        
        .tab-content {
            padding: 30px;
            min-height: 500px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .btn {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }
        
        .search-box {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-box input {
            padding-left: 45px;
        }
        
        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }
        
        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .records-table th {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .records-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .records-table tr:hover {
            background: #f8f9fa;
        }
        
        .rank-a { color: #dc3545; font-weight: bold; }
        .rank-b { color: #fd7e14; font-weight: bold; }
        .rank-c { color: #28a745; font-weight: bold; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #4facfe;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1.1em;
            color: #666;
            font-weight: 600;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .tab-content {
                padding: 20px 15px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-group input, .form-group select, .form-group textarea {
                font-size: 16px; /* prevent zoom on iOS */
                padding: 15px;
            }
            
            .tabs {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            
            .tabs::-webkit-scrollbar {
                display: none;
            }
            
            .tab {
                font-size: 12px;
                padding: 12px 8px;
                min-width: 100px;
                -webkit-tap-highlight-color: transparent;
            }
            
            .records-table {
                font-size: 12px;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            .records-table thead,
            .records-table tbody,
            .records-table th,
            .records-table td,
            .records-table tr {
                display: block;
            }
            
            .records-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .records-table tr {
                background: white;
                border: 1px solid #e9ecef;
                border-radius: 10px;
                margin-bottom: 10px;
                padding: 15px;
                position: relative;
            }
            
            .records-table td {
                border: none;
                position: relative;
                padding: 8px 0;
                text-align: left;
                white-space: normal;
            }
            
            .records-table td:before {
                content: attr(data-label) ": ";
                font-weight: bold;
                color: #666;
                display: inline-block;
                width: 100px;
            }
            
            .btn {
                padding: 15px 25px;
                font-size: 16px;
                margin: 5px;
                -webkit-tap-highlight-color: transparent;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .stat-card {
                padding: 20px 15px;
            }
            
            .stat-number {
                font-size: 2em;
            }
            
            .search-box input {
                font-size: 16px;
                padding: 15px 15px 15px 45px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà Âñ∂Ê•≠ÈÄ≤ÊçóÁÆ°ÁêÜ„ÉÑ„Éº„É´</h1>
            <p>ÂäπÁéáÁöÑ„Å™Âñ∂Ê•≠Ê¥ªÂãï„Çí„Çµ„Éù„Éº„Éà</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('input')">üìù Êñ∞Ë¶èÁôªÈå≤</button>
            <button class="tab" onclick="showTab('list')">üìã ‰∏ÄË¶ß„ÉªÊ§úÁ¥¢</button>
            <button class="tab" onclick="showTab('stats')">üìä Áµ±Ë®à</button>
        </div>
        
        <div id="input-tab" class="tab-content">
            <h2 id="form-title">üìù Êñ∞Ë¶èË®™ÂïèË®òÈå≤</h2>
            <div id="success-message" class="success-message hidden">
                ‚úÖ Ë®òÈå≤„ÅåÊ≠£Â∏∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„ÅüÔºÅ
            </div>
            
            <form id="visitForm">
                <input type="hidden" id="editId" value="">
                <div class="form-row">
                    <div class="form-group">
                        <label for="company">Ë®™ÂïèÂÖàÔºà‰ºöÁ§æÂêçÔºâ*</label>
                        <input type="text" id="company" required>
                    </div>
                    <div class="form-group">
                        <label for="contact">ÊãÖÂΩìËÄÖÂêç</label>
                        <input type="text" id="contact">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="address">‰ΩèÊâÄ</label>
                    <input type="text" id="address">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">ÈõªË©±Áï™Âè∑</label>
                        <input type="tel" id="phone">
                    </div>
                    <div class="form-group">
                        <label for="rank">„É©„É≥„ÇØ*</label>
                        <select id="rank" required>
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="A">AÔºàÊúÄÈáçË¶ÅÔºâ</option>
                            <option value="B">BÔºàÈáçË¶ÅÔºâ</option>
                            <option value="C">CÔºàÈÄöÂ∏∏Ôºâ</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">Ë®™ÂïèÊó•*</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="status">Ë®™ÂïèÁµêÊûú</label>
                        <select id="status">
                            <option value="Ë®™ÂïèÊ∏à„Åø">Ë®™ÂïèÊ∏à„Åø</option>
                            <option value="‰∏çÂú®">‰∏çÂú®</option>
                            <option value="„Ç¢„ÉùÂèñÂæó">„Ç¢„ÉùÂèñÂæó</option>
                            <option value="ÂïÜË´á">ÂïÜË´á</option>
                            <option value="ÂèóÊ≥®">ÂèóÊ≥®</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="nextVisit">Ê¨°ÂõûË®™Âïè‰∫àÂÆöÊó•</label>
                        <input type="date" id="nextVisit">
                    </div>
                    <div class="form-group">
                        <label for="followUp">„Éï„Ç©„É≠„Éº„Ç¢„ÉÉ„ÉóÂøÖË¶ÅÂ∫¶</label>
                        <select id="followUp">
                            <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="Á∑äÊÄ•">Á∑äÊÄ•Ôºà1ÈÄ±Èñì‰ª•ÂÜÖÔºâ</option>
                            <option value="È´ò">È´òÔºà2ÈÄ±Èñì‰ª•ÂÜÖÔºâ</option>
                            <option value="‰∏≠">‰∏≠Ôºà1„É∂Êúà‰ª•ÂÜÖÔºâ</option>
                            <option value="‰Ωé">‰ΩéÔºàÈÅ©ÂÆúÔºâ</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>üìû È°ßÂÆ¢„Åã„Çâ„ÅÆÂèçÂøú</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="inquiries">Âïè„ÅÑÂêà„Çè„ÅõÊï∞Ôºà‰ª∂Ôºâ</label>
                            <input type="number" id="inquiries" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="users">Âà©Áî®ËÄÖÊï∞Ôºà‰∫∫Ôºâ</label>
                            <input type="number" id="users" min="0" placeholder="0">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="content">Ë®™ÂïèÂÜÖÂÆπ„Éª„É°„É¢</label>
                    <textarea id="content" rows="4" placeholder="Ë®™Âïè„ÅÆË©≥Á¥∞„ÄÅÊ¨°Âõû„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥Á≠â„ÇíË®òÂÖ•"></textarea>
                </div>
                
                <button type="submit" class="btn" id="submit-btn">üíæ Ë®òÈå≤„Çí‰øùÂ≠ò</button>
                <button type="button" class="btn btn-secondary" onclick="clearForm()">üîÑ „ÇØ„É™„Ç¢</button>
                <button type="button" class="btn btn-secondary hidden" id="cancel-edit-btn" onclick="cancelEdit()">‚ùå Á∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´</button>
            </form>
        </div>
        
        <div id="list-tab" class="tab-content hidden">
            <h2>üìã Ë®™ÂïèË®òÈå≤‰∏ÄË¶ß</h2>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="‰ºöÁ§æÂêç„ÄÅÊãÖÂΩìËÄÖÂêç„ÄÅ‰ΩèÊâÄ„ÅßÊ§úÁ¥¢...">
            </div>
            
            <div style="margin-bottom: 20px;">
                <select id="rankFilter">
                    <option value="">ÂÖ®„Å¶„ÅÆ„É©„É≥„ÇØ</option>
                    <option value="A">A„É©„É≥„ÇØ„ÅÆ„Åø</option>
                    <option value="B">B„É©„É≥„ÇØ„ÅÆ„Åø</option>
                    <option value="C">C„É©„É≥„ÇØ„ÅÆ„Åø</option>
                </select>
                
                <select id="statusFilter" style="margin-left: 10px;">
                    <option value="">ÂÖ®„Å¶„ÅÆÁµêÊûú</option>
                    <option value="Ë®™ÂïèÊ∏à„Åø">Ë®™ÂïèÊ∏à„Åø</option>
                    <option value="‰∏çÂú®">‰∏çÂú®</option>
                    <option value="„Ç¢„ÉùÂèñÂæó">„Ç¢„ÉùÂèñÂæó</option>
                    <option value="ÂïÜË´á">ÂïÜË´á</option>
                    <option value="ÂèóÊ≥®">ÂèóÊ≥®</option>
                </select>
                
                <button class="btn" onclick="exportData()" style="margin-left: 10px;">üì• CSV„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
                <button class="btn" onclick="importData()" style="margin-left: 10px;">üì§ CSV„Ç§„É≥„Éù„Éº„Éà</button>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileImport(this)">
                <button class="btn btn-secondary" onclick="clearAllData()" style="margin-left: 10px; background: #dc3545;">üóëÔ∏è ÂÖ®„Éá„Éº„ÇøÂâäÈô§</button>
            </div>
            
            <div id="recordsList">
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>Êó•‰ªò</th>
                            <th>‰ºöÁ§æÂêç</th>
                            <th>ÊãÖÂΩìËÄÖ</th>
                            <th>„É©„É≥„ÇØ</th>
                            <th>ÁµêÊûú</th>
                            <th>Ê¨°Âõû‰∫àÂÆö</th>
                            <th>ÂïèÂêà„Åõ</th>
                            <th>Âà©Áî®ËÄÖ</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <!-- Records will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="stats-tab" class="tab-content hidden">
            <h2>üìä Áµ±Ë®àÊÉÖÂ†±</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalVisits">0</div>
                    <div class="stat-label">Á∑èË®™ÂïèÊï∞</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="totalCompanies">0</div>
                    <div class="stat-label">Ë®™ÂïèÂÖà‰ºÅÊ•≠Êï∞</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="rankACount">0</div>
                    <div class="stat-label">A„É©„É≥„ÇØ‰ºÅÊ•≠</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="successRate">0%</div>
                    <div class="stat-label">ÂèóÊ≥®Áéá</div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>üìÖ ÊúàÂà•Ë®™ÂïèÊï∞</h3>
                <div id="monthlyStats"></div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>üìÖ ÊúàÂà•Ë®™ÂïèÊï∞</h3>
                <div id="monthlyStats"></div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>üèÜ „É©„É≥„ÇØÂà•ÂàÜÊûê</h3>
                <div id="rankStats"></div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>üìÖ Ê¨°ÂõûË®™Âïè‰∫àÂÆö</h3>
                <div id="upcomingVisits"></div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>üìû È°ßÂÆ¢ÂèçÂøú„Çµ„Éû„É™„Éº</h3>
                <div id="responseStats"></div>
            </div>
        </div>
    </div>

    <script>
// --- Ë®≠ÂÆö ---
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxKetPcG4IaeJanpPFpoYvQfCrv3dIxZLaTc37oASJ_XpvP5Pbii5qGGvOYIuDwdUO5/exec';
// -----------

let visits = []; // „Éá„Éº„Çø„ÅØÂ∏∏„Å´„Çµ„Éº„Éê„Éº„Åã„ÇâÂèñÂæó

// ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('date').valueAsDate = new Date();
    setupEventListeners();
    loadData(); // „Éá„Éº„Çø„Çí„Çµ„Éº„Éê„Éº„Åã„ÇâË™≠„ÅøËæº„ÇÄ
});

function setupEventListeners() {
    document.getElementById('visitForm').addEventListener('submit', saveVisit);
    document.getElementById('searchInput').addEventListener('input', displayRecords);
    document.getElementById('rankFilter').addEventListener('change', displayRecords);
    document.getElementById('statusFilter').addEventListener('change', displayRecords);
    document.querySelectorAll('.tab').forEach(tabButton => {
        tabButton.addEventListener('click', () => {
            const tabName = tabButton.dataset.tab;
            showTab(tabName);
        });
    });
}

function showLoading(show) {
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫ÔºàÁ∞°ÊòìÁâà„ÄÅÂøÖË¶Å„Å´Âøú„Åò„Å¶„Çπ„Çø„Ç§„É´„ÇíË™øÊï¥Ôºâ
    const loader = document.getElementById('loader') || document.createElement('div');
    loader.id = 'loader';
    if(show) {
        loader.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 2em;';
        loader.textContent = 'üîÑ Ë™≠„ÅøËæº„Åø‰∏≠...';
        document.body.appendChild(loader);
    } else {
        if (loader.parentNode) {
            loader.parentNode.removeChild(loader);
        }
    }
}

// „Éá„Éº„Çø„Çí„Çµ„Éº„Éê„Éº„Åã„ÇâË™≠„ÅøËæº„Åø
async function loadData() {
    showLoading(true);
    try {
        const response = await fetch(SCRIPT_URL);
        if (!response.ok) throw new Error('Network response was not ok');
        visits = await response.json();
        // Êï∞ÂÄ§Âûã„Å´Â§âÊèõ
        visits.forEach(v => {
            v.id = parseInt(v.id);
            v.inquiries = parseInt(v.inquiries) || 0;
            v.users = parseInt(v.users) || 0;
        });
        displayRecords();
        updateStats();
    } catch (error) {
        console.error('Error loading data:', error);
        alert('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
    } finally {
        showLoading(false);
    }
}

// Ë®™ÂïèË®òÈå≤„Çí‰øùÂ≠ò„ÉªÊõ¥Êñ∞
async function saveVisit(e) {
    e.preventDefault();
    showLoading(true);
    
    const editId = document.getElementById('editId').value;
    const isEditing = !!editId;

    const visit = {
        id: isEditing ? parseInt(editId) : Date.now(),
        company: document.getElementById('company').value,
        contact: document.getElementById('contact').value,
        address: document.getElementById('address').value,
        phone: document.getElementById('phone').value,
        rank: document.getElementById('rank').value,
        date: document.getElementById('date').value,
        status: document.getElementById('status').value,
        nextVisit: document.getElementById('nextVisit').value,
        followUp: document.getElementById('followUp').value,
        inquiries: parseInt(document.getElementById('inquiries').value) || 0,
        users: parseInt(document.getElementById('users').value) || 0,
        content: document.getElementById('content').value,
        lastModified: new Date().toISOString()
    };

    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'save', record: visit }),
            headers: { 'Content-Type': 'application/json' },
        });

        const result = await response.json();
        if (result.status === 'success') {
            await loadData(); // „Çµ„Éº„Éê„Éº„Åã„Çâ„Éá„Éº„Çø„ÇíÂÜçË™≠„ÅøËæº„Åø
            showSuccessMessage(isEditing ? 'Êõ¥Êñ∞' : '‰øùÂ≠ò');
            clearForm();
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('Error saving data:', error);
        alert('„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// Ë®òÈå≤„ÇíÂâäÈô§
async function deleteVisit(id) {
    if (confirm('„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
        showLoading(true);
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'delete', record: { id: id } }),
                headers: { 'Content-Type': 'application/json' },
            });
            const result = await response.json();
            if (result.status === 'success') {
                await loadData(); // ÂÜçË™≠„ÅøËæº„Åø
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error deleting data:', error);
            alert('„Éá„Éº„Çø„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
        } finally {
            showLoading(false);
        }
    }
}

// ÂÖ®„Éá„Éº„ÇøÂâäÈô§
async function clearAllData() {
    if (confirm('ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü\n‚Äª„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ')) {
        if (confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà‰∏ä„ÅÆ„Éá„Éº„Çø„ÅåÂÖ®„Å¶Ê∂à„Åà„Åæ„Åô„ÄÇ')) {
            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'clearAll' }),
                    headers: { 'Content-Type': 'application/json' },
                });
                const result = await response.json();
                if (result.status === 'success') {
                    await loadData();
                    alert('ÂÖ®„Å¶„ÅÆ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error clearing data:', error);
                alert('ÂÖ®„Éá„Éº„ÇøÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
    }
}

function showSuccessMessage(actionType) {
    const message = document.getElementById('success-message');
    message.innerHTML = `‚úÖ Ë®òÈå≤„ÅåÊ≠£Â∏∏„Å´${actionType}„Åï„Çå„Åæ„Åó„ÅüÔºÅ`;
    message.classList.remove('hidden');
    setTimeout(() => {
        message.classList.add('hidden');
    }, 3000);
}

// CSV„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÔºà„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Åã„ÇâÁõ¥Êé•DL„Åô„Çã„Åª„ÅÜ„Åå‰æøÂà©„Å™„ÅÆ„ÅßÁ∞°ÊòìÂåñÔºâ
function exportData() {
    alert('Google„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Åã„ÇâÁõ¥Êé•CSVÂΩ¢Âºè„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
}

// CSV„Ç§„É≥„Éù„Éº„ÉàÔºàÂêåÊßò„Å´„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´Áõ¥Êé•Ë≤º„Çä‰ªò„Åë„ÇíÊé®Â•®Ôºâ
function importData() {
    alert('Google„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„Éà„Å´Áõ¥Êé•„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
}

// „Åì„Çå‰ª•Èôç„ÅÆÈñ¢Êï∞ÔºàclearForm, editVisit, displayRecords„Å™„Å©Ôºâ„ÅØ„ÄÅ
// „É≠„Éº„Ç´„É´ÁâàÔºàÂâçÂõû„ÅÆÂõûÁ≠îÔºâ„Å®„Åª„ÅºÂêå„Åò„Å™„ÅÆ„Åß„ÄÅÁúÅÁï•„Åõ„Åö„Å´„Åù„ÅÆ„Åæ„ÅæË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
// „Åü„Å†„Åó„ÄÅsaveData, loadData „ÅÆ„Çà„ÅÜ„Å´„Çµ„Éº„Éê„ÉºÈÄö‰ø°„Å´ÁΩÆ„ÅçÊèõ„Çè„Å£„ÅüÈñ¢Êï∞„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ
// ‰ª•‰∏ã„Å´ÂÜçÊé≤„Åó„Åæ„Åô„ÄÇ

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.remove('hidden');
    document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
    if (tabName === 'stats') updateStats();
    if (tabName === 'list') displayRecords();
}

function clearForm() {
    document.getElementById('visitForm').reset();
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('editId').value = '';
    document.getElementById('form-title').textContent = 'üìù Êñ∞Ë¶èË®™ÂïèË®òÈå≤';
    document.getElementById('submit-btn').textContent = 'üíæ Ë®òÈå≤„Çí‰øùÂ≠ò';
    document.getElementById('cancel-edit-btn').classList.add('hidden');
}

function editVisit(id) {
    const visit = visits.find(v => v.id === id);
    if (!visit) return;
    
    document.getElementById('editId').value = visit.id;
    document.getElementById('company').value = visit.company;
    document.getElementById('contact').value = visit.contact || '';
    document.getElementById('address').value = visit.address || '';
    document.getElementById('phone').value = visit.phone || '';
    document.getElementById('rank').value = visit.rank;
    document.getElementById('date').value = visit.date;
    document.getElementById('status').value = visit.status;
    document.getElementById('content').value = visit.content || '';
    document.getElementById('nextVisit').value = visit.nextVisit || '';
    document.getElementById('followUp').value = visit.followUp || '';
    document.getElementById('inquiries').value = visit.inquiries || 0;
    document.getElementById('users').value = visit.users || 0;
    
    document.getElementById('form-title').textContent = '‚úèÔ∏è Ë®™ÂïèË®òÈå≤„ÅÆÁ∑®ÈõÜ';
    document.getElementById('submit-btn').textContent = 'üíæ Â§âÊõ¥„Çí‰øùÂ≠ò';
    document.getElementById('cancel-edit-btn').classList.remove('hidden');
    
    showTab('input');
}

function cancelEdit() {
    clearForm();
}

function displayRecords() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rankFilter = document.getElementById('rankFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    let filteredVisits = visits.filter(visit => {
        const company = visit.company || '';
        const contact = visit.contact || '';
        const address = visit.address || '';
        const matchesSearch = company.toLowerCase().includes(searchTerm) ||
                            contact.toLowerCase().includes(searchTerm) ||
                            address.toLowerCase().includes(searchTerm);
        
        const matchesRank = !rankFilter || visit.rank === rankFilter;
        const matchesStatus = !statusFilter || visit.status === statusFilter;
        
        return matchesSearch && matchesRank && matchesStatus;
    });
    
    filteredVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const tbody = document.getElementById('recordsBody');
    tbody.innerHTML = '';
    
    filteredVisits.forEach(visit => {
        const row = document.createElement('tr');
        const nextVisitWarning = getNextVisitWarning(visit.nextVisit);
        const nextVisitDisplay = visit.nextVisit ? 
            `<span style="${nextVisitWarning.style}">${formatDate(visit.nextVisit)} ${nextVisitWarning.icon}</span>` : 
            '-';
        
        row.innerHTML = `
            <td data-label="Êó•‰ªò">${formatDate(visit.date)}</td>
            <td data-label="‰ºöÁ§æÂêç"><strong>${visit.company}</strong></td>
            <td data-label="ÊãÖÂΩìËÄÖ">${visit.contact || '-'}</td>
            <td data-label="„É©„É≥„ÇØ"><span class="rank-${visit.rank.toLowerCase()}">${visit.rank}</span></td>
            <td data-label="ÁµêÊûú">${visit.status}</td>
            <td data-label="Ê¨°Âõû‰∫àÂÆö">${nextVisitDisplay}</td>
            <td data-label="ÂïèÂêà„Åõ">${visit.inquiries || 0}‰ª∂</td>
            <td data-label="Âà©Áî®ËÄÖ">${visit.users || 0}‰∫∫</td>
            <td data-label="Êìç‰Ωú">
                <button onclick="editVisit(${visit.id})" style="background:#28a745; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; margin-right:5px;">Á∑®ÈõÜ</button>
                <button onclick="deleteVisit(${visit.id})" style="background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">ÂâäÈô§</button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    if (filteredVisits.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px; color:#666;">Ë©≤ÂΩì„Åô„ÇãË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>';
    }
}

// „Åì„Çå‰ª•Èôç„ÅÆÁµ±Ë®àÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞„ÅØÂ§âÊõ¥„Å™„Åó„ÅßOK
function getNextVisitWarning(nextVisitDate) {
    if (!nextVisitDate) return { style: '', icon: '' };
    const today = new Date();
    const nextDate = new Date(nextVisitDate);
    const diffTime = nextDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    if (diffDays < 0) return { style: 'color: #dc3545; font-weight: bold;', icon: '‚ö†Ô∏è' };
    if (diffDays <= 3) return { style: 'color: #fd7e14; font-weight: bold;', icon: 'üîî' };
    if (diffDays <= 7) return { style: 'color: #ffc107; font-weight: bold;', icon: 'üìÖ' };
    return { style: '', icon: '' };
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return '-';
    return `${date.getMonth() + 1}/${date.getDate()}`;
}

function updateStats() {
    const totalVisits = visits.length;
    const uniqueCompanies = new Set(visits.map(v => v.company)).size;
    const rankACount = visits.filter(v => v.rank === 'A').length;
    const successCount = visits.filter(v => v.status === 'ÂèóÊ≥®').length;
    const successRate = totalVisits > 0 ? Math.round((successCount / totalVisits) * 100) : 0;
    
    document.getElementById('totalVisits').textContent = totalVisits;
    document.getElementById('totalCompanies').textContent = uniqueCompanies;
    document.getElementById('rankACount').textContent = rankACount;
    document.getElementById('successRate').textContent = successRate + '%';
    
    updateMonthlyStats();
    updateRankStats();
    updateUpcomingVisits();
    updateResponseStats();
}

function updateMonthlyStats() {
    const monthlyData = {};
    visits.forEach(visit => {
        if(!visit.date) return;
        const month = visit.date.substring(0, 7); // YYYY-MM
        monthlyData[month] = (monthlyData[month] || 0) + 1;
    });
    const monthlyStatsEl = document.getElementById('monthlyStats');
    monthlyStatsEl.innerHTML = '';
    Object.entries(monthlyData).sort((a, b) => b[0].localeCompare(a[0])).forEach(([month, count]) => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; justify-content: space-between; padding: 10px; background: white; margin: 5px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
        div.innerHTML = `<span>${month}</span><strong>${count}‰ª∂</strong>`;
        monthlyStatsEl.appendChild(div);
    });
    if (Object.keys(monthlyData).length === 0) {
        monthlyStatsEl.innerHTML = '<p style="text-align:center; color:#666;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    }
}

function updateRankStats() {
    const rankData = { 'A': 0, 'B': 0, 'C': 0 };
    visits.forEach(v => {
        if (v.rank && rankData.hasOwnProperty(v.rank)) {
            rankData[v.rank]++;
        }
    });
    const rankStatsEl = document.getElementById('rankStats');
    rankStatsEl.innerHTML = '';
    Object.entries(rankData).forEach(([rank, count]) => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; justify-content: space-between; padding: 10px; background: white; margin: 5px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
        div.innerHTML = `<span class="rank-${rank.toLowerCase()}">${rank}„É©„É≥„ÇØ</span><strong>${count}‰ª∂</strong>`;
        rankStatsEl.appendChild(div);
    });
}

function updateUpcomingVisits() {
    const today = new Date();
    today.setHours(0,0,0,0);
    const upcomingVisits = visits
        .filter(v => v.nextVisit)
        .map(v => ({...v, daysUntil: Math.ceil((new Date(v.nextVisit) - today) / (1000 * 60 * 60 * 24)) }))
        .filter(v => v.daysUntil >= 0) // Êú™Êù•„ÅÆ‰∫àÂÆö„ÅÆ„Åø
        .sort((a, b) => a.daysUntil - b.daysUntil)
        .slice(0, 10);
    
    const upcomingEl = document.getElementById('upcomingVisits');
    upcomingEl.innerHTML = '';
    
    if (upcomingVisits.length === 0) {
        upcomingEl.innerHTML = '<p style="text-align:center; color:#666;">‰∫àÂÆö„Åï„Çå„ÅüË®™Âïè„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
        return;
    }
    
    upcomingVisits.forEach(visit => {
        const div = document.createElement('div');
        const warning = getNextVisitWarning(visit.nextVisit);
        const urgencyText = visit.daysUntil === 0 ? '‰ªäÊó•' : `${visit.daysUntil}Êó•Âæå`;
        div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; margin: 5px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
        div.innerHTML = `<div><strong>${visit.company}</strong><span style="margin-left: 10px; color: #666;">${visit.followUp ? `(${visit.followUp})` : ''}</span></div><span style="${warning.style}">${urgencyText} ${warning.icon}</span>`;
        upcomingEl.appendChild(div);
    });
}

function updateResponseStats() {
    const totalInquiries = visits.reduce((sum, v) => sum + (v.inquiries || 0), 0);
    const totalUsers = visits.reduce((sum, v) => sum + (v.users || 0), 0);
    const avgInquiries = visits.length > 0 ? (totalInquiries / visits.length).toFixed(1) : 0;
    const avgUsers = visits.length > 0 ? (totalUsers / visits.length).toFixed(1) : 0;

    const responseEl = document.getElementById('responseStats');
    responseEl.innerHTML = '';
    const stats = [
        { label: 'Á∑èÂïè„ÅÑÂêà„Çè„ÅõÊï∞', value: `${totalInquiries}‰ª∂`, color: '#4facfe' },
        { label: 'Á∑èÂà©Áî®ËÄÖÊï∞', value: `${totalUsers}‰∫∫`, color: '#00f2fe' },
        { label: 'Âπ≥ÂùáÂïè„ÅÑÂêà„Çè„Åõ/Ë®™Âïè', value: `${avgInquiries}‰ª∂`, color: '#667eea' },
        { label: 'Âπ≥ÂùáÂà©Áî®ËÄÖ/Ë®™Âïè', value: `${avgUsers}‰∫∫`, color: '#764ba2' }
    ];
    stats.forEach(stat => {
        const div = document.createElement('div');
        div.style.cssText = 'display: flex; justify-content: space-between; padding: 10px; background: white; margin: 5px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
        div.innerHTML = `<span>${stat.label}</span><strong style="color: ${stat.color};">${stat.value}</strong>`;
        responseEl.appendChild(div);
    });
}
    </script>
</body>
</html>
